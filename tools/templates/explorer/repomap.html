{% extends "explorer/base.html" %}

{% block content %}
<h1 class="mb-4">{{ title }}</h1>

<form method="post" class="mb-5">
  <div class="mb-3">
    <label for="prompt" class="form-label">Prompt</label>
    <textarea class="form-control" id="prompt" name="prompt" rows="3">{{ form_values.prompt or '' }}</textarea>
    <div class="form-text">Any symbol or file names mentioned here will be used as additional boost seeds.</div>
  </div>
  <div class="mb-3">
    <label for="symbol_names" class="form-label">Symbol Names (comma-separated)</label>
    <textarea class="form-control" id="symbol_names" name="symbol_names" rows="2">{{ form_values.symbol_names or '' }}</textarea>
  </div>
  <div class="mb-3">
    <label for="file_paths" class="form-label">File Paths (comma-separated)</label>
    <textarea class="form-control" id="file_paths" name="file_paths" rows="2">{{ form_values.file_paths or '' }}</textarea>
  </div>

  <div class="row g-3 align-items-center mb-3">
    <div class="col-auto">
      <label for="limit" class="form-label">Limit</label>
      <input type="number" class="form-control" id="limit" name="limit" value="{{ form_values.get('limit') or '20' }}" min="1">
    </div>
    <div class="col-auto">
      <label for="restart_prob" class="form-label">Restart Probability</label>
      <input type="number" class="form-control" id="restart_prob" name="restart_prob" value="{{ form_values.get('restart_prob') or '0.15' }}" step="0.01" min="0" max="1">
    </div>
    <div class="col-auto">
        <label for="min_symbol_len" class="form-label">Min Symbol Len</label>
        <input type="number" class="form-control" id="min_symbol_len" name="min_symbol_len" value="{{ form_values.get('min_symbol_len') or '3' }}" min="1">
    </div>
  </div>

  <div class="row g-3 align-items-center mb-3">
    <div class="col-auto">
        <label for="token_limit_count" class="form-label">Token Limit Count</label>
        <input type="number" class="form-control" id="token_limit_count" name="token_limit_count" value="{{ form_values.get('token_limit_count') or '' }}" min="1">
    </div>
    <div class="col-auto">
        <label for="token_limit_model" class="form-label">Token Limit Model</label>
        <input type="text" class="form-control" id="token_limit_model" name="token_limit_model" value="{{ form_values.get('token_limit_model') or '' }}">
    </div>
  </div>

  <div class="row g-3 align-items-center mb-3">
    <div class="col-auto">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="include_summary" name="include_summary" value="on" {% if (not form_values and not request.method == 'POST') or form_values.get('include_summary') == 'on' %}checked{% endif %}>
        <label class="form-check-label" for="include_summary">Include Summary</label>
      </div>
    </div>
    <div class="col-auto">
      <label for="summary_mode" class="form-label">Summary Mode</label>
      <select class="form-select" id="summary_mode" name="summary_mode">
        {% for mode in summary_modes %}
          <option value="{{ mode }}" {% if (not form_values and mode == 'summary_short') or (form_values.get('summary_mode') == mode) %}selected{% endif %}>{{ mode }}</option>
        {% endfor %}
      </select>
    </div>
  </div>

  <button type="submit" class="btn btn-primary">Run RepoMap</button>
</form>

{% if results is not none %}
  <h2>Results</h2>
  {% if results %}
    <table class="table">
      <thead>
        <tr>
          <th>File Path</th>
          <th>Score</th>
          <th>Summary</th>
        </tr>
      </thead>
      <tbody>
        {% for result in results %}
          <tr>
            <td>
                {% if result.file_obj %}
                    {{ _link_to(result.file_obj) | safe }}
                {% else %}
                    {{ result.file_path }}
                {% endif %}
            </td>
            <td>{{ "%.4f"|format(result.score) }}</td>
            <td>
              {% if result.summary %}
                <pre style="white-space: pre-wrap; word-wrap: break-word;"><code>{{ result.summary }}</code></pre>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p>No results found.</p>
  {% endif %}
{% endif %}

{% endblock %}
